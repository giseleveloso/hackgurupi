<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Calor - Votos por Localiza√ß√£o</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        #map { 
            height: 100vh; 
            width: 100%; 
        }
        
        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 300px;
        }
        
        .controls h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
        }
        
        .control-group select,
        .control-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            width: 100%;
            padding: 10px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        .stats {
            margin-top: 15px;
            padding: 10px;
            background: #ecf0f1;
            border-radius: 4px;
            font-size: 13px;
            color: #555;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="controls">
        <h3>üó∫Ô∏è Mapa de Calor</h3>
        
        <div class="control-group">
            <label>Projeto (opcional):</label>
            <select id="projetoSelect">
                <option value="">Todos os projetos</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>Precis√£o:</label>
            <select id="precisionSelect">
                <option value="3">Baixa (~100m)</option>
                <option value="4" selected>M√©dia (~10m)</option>
                <option value="5">Alta (~1m)</option>
            </select>
        </div>
        
        <button onclick="loadHeatmap()">Atualizar Mapa</button>
        
        <div class="stats" id="stats">
            Carregue o mapa para ver estat√≠sticas
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    
    <script>
        const API_URL = window.location.origin;
        
        // Inicializa mapa centrado em Gurupi, TO
        const map = L.map('map').setView([-11.7289, -49.0683], 13);
        
        // Adiciona camada do OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        let heatLayer = null;
        
        // Carrega projetos para o select
        async function loadProjetos() {
            try {
                const response = await fetch(`${API_URL}/projetos`);
                const projetos = await response.json();
                
                const select = document.getElementById('projetoSelect');
                projetos.forEach(projeto => {
                    const option = document.createElement('option');
                    option.value = projeto.id;
                    option.textContent = projeto.titulo;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar projetos:', error);
            }
        }
        
        // Carrega dados do mapa de calor
        async function loadHeatmap() {
            const projetoId = document.getElementById('projetoSelect').value;
            const precision = document.getElementById('precisionSelect').value;
            
            try {
                let url = `${API_URL}/heatmap?precision=${precision}`;
                if (projetoId) {
                    url = `${API_URL}/heatmap/projeto/${projetoId}?precision=${precision}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                // Remove camada anterior se existir
                if (heatLayer) {
                    map.removeLayer(heatLayer);
                }
                
                // Converte dados para formato do Leaflet Heat
                const heatData = data.map(point => [
                    point.lat,
                    point.lng,
                    point.weight
                ]);
                
                // Adiciona nova camada de calor
                heatLayer = L.heatLayer(heatData, {
                    radius: 25,
                    blur: 15,
                    maxZoom: 17,
                    max: 1.0,
                    gradient: {
                        0.0: 'blue',
                        0.5: 'yellow',
                        1.0: 'red'
                    }
                }).addTo(map);
                
                // Atualiza estat√≠sticas
                const totalPoints = data.length;
                const maxWeight = Math.max(...data.map(p => p.weight));
                document.getElementById('stats').innerHTML = `
                    üìç Pontos: ${totalPoints}<br>
                    üî• Intensidade m√°x: ${(maxWeight * 100).toFixed(0)}%
                `;
                
                // Ajusta zoom para mostrar todos os pontos
                if (heatData.length > 0) {
                    const bounds = L.latLngBounds(heatData.map(p => [p[0], p[1]]));
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
                
            } catch (error) {
                console.error('Erro ao carregar mapa de calor:', error);
                alert('Erro ao carregar dados do mapa de calor');
            }
        }
        
        // Inicializa√ß√£o
        loadProjetos();
        loadHeatmap();
    </script>
</body>
</html>

